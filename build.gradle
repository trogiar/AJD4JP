/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java library project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.13/userguide/building_java_projects.html in the Gradle documentation.
 */

plugins {
    // Apply the java-library plugin for API and implementation separation.
    id 'java-library'
}

// AJD4JPのバージョン情報
ext {
    ajd4jpVersion = '8.0.2.2021'
    ajd4jpAuthor = 'Akira Terasaki'
    ajd4jpTarName = "ajd4jp-${ajd4jpVersion}"
    ajd4jpJarName = "${ajd4jpTarName}.jar"
    ajd4jpCrtName = "ajd4jp.jar"
}

// ディレクトリ設定
def srcDir = 'ajd4jp'
def classDir = 'classes'
def jarDir = 'bin'
def apiDir = 'docs/javadoc'

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Use JUnit Jupiter for testing.
    testImplementation libs.junit.jupiter

    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    // This dependency is exported to consumers, that is to say found on their compile classpath.
    api libs.commons.math3

    // This dependency is used internally, and not exposed to consumers on their own compile classpath.
    implementation libs.guava
}

// ソースセットの設定
sourceSets {
    main {
        java {
            srcDirs = [srcDir]
        }
    }
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(8)
    }
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

// Version.javaの生成タスク
task generateVersionJava {
    def versionJavaFile = file("${srcDir}/Version.java")
    def templateFile = file('template/Version.java')
    
    def version = project.ext.ajd4jpVersion
    def author = project.ext.ajd4jpAuthor
    
    inputs.property('version', version)
    inputs.property('author', author)
    inputs.file(templateFile)
    outputs.file(versionJavaFile)
    
    doLast {
        // ファイルを明示的にUTF-8として読み込む
        def template = templateFile.getText('UTF-8')
        def versionJava = template.replace('@@@ver', version)
                                  .replace('@@@auth', author)
        // ファイルを明示的にUTF-8として書き込む
        versionJavaFile.setText(versionJava, 'UTF-8')
    }
}

// コンパイル前にVersion.javaを生成
compileJava.dependsOn generateVersionJava

// JARファイルの設定
jar {
    destinationDirectory = file("${jarDir}")
    archiveFileName = project.ext.ajd4jpJarName
    
    manifest {
        attributes(
            'Extension-Name': 'ajd4jp',
            'Specification-Title': 'AJD4JP DB Library',
            'Specification-Version': project.ext.ajd4jpVersion,
            'Specification-Vendor': project.ext.ajd4jpAuthor,
            'Implementation-Title': 'ajd4jp',
            'Implementation-Version': project.ext.ajd4jpVersion,
            'Implementation-Vendor': project.ext.ajd4jpAuthor,
            'Sealed': 'true'
        )
    }
}

// ソースアーカイブ作成タスク
task createSourceArchive(type: Tar) {
    dependsOn jar
    
    archiveFileName = "${project.ext.ajd4jpTarName}.src.tar.gz"
    destinationDirectory = file(jarDir)
    compression = Compression.GZIP
    
    into(project.ext.ajd4jpTarName) {
        from('.') {
            include 'LICENSE'
            include 'build.gradle'
            include 'settings.gradle'
            include "${srcDir}/**"
            include 'template/**'
        }
    }
}

// Javadoc設定
javadoc {
    destinationDir = file(apiDir)
    options {
        encoding = 'UTF-8'
        charSet = 'UTF-8'
        docEncoding = 'UTF-8'
        locale = 'ja_JP'
        windowTitle = "AJD4JP ${project.ext.ajd4jpVersion} API"
        overview = 'template/overview.html'
        docTitle = "AJD4JP ${project.ext.ajd4jpVersion} API 仕様"
        
        // HTMLタグとエンティティを許可するオプション
        addStringOption('Xdoclint:none', '-quiet')
    }
    
    source = sourceSets.main.allJava
    excludes = ['ajd4jp/util/**', 'ajd4jp/orrery/tool/**']
    
    options.links = ['https://docs.oracle.com/javase/jp/8/docs/api/']
}

// ajd4jp.jarへのシンボリックリンク作成タスク
task createJarSymlink(type: Exec) {
    dependsOn jar
    workingDir jarDir
    
    // Windows以外の環境でのみシンボリックリンクを作成
    onlyIf { !System.getProperty('os.name').toLowerCase().contains('windows') }
    
    commandLine 'ln', '-fs', project.ext.ajd4jpJarName, project.ext.ajd4jpCrtName
}

// Windowsでのシンボリックリンク作成(コピー)
task createJarCopy(type: Copy) {
    dependsOn jar
    
    // Windowsの環境でのみコピーを作成
    onlyIf { System.getProperty('os.name').toLowerCase().contains('windows') }
    
    doFirst {
        from "${jarDir}/${project.ext.ajd4jpJarName}"
        into jarDir
        rename { String fileName -> project.ext.ajd4jpCrtName }
    }
}

// ビルドタスク
task buildAjd4jp {
    dependsOn jar, createSourceArchive, javadoc, createJarSymlink, createJarCopy
    description = 'AJD4JPのビルド処理を実行します'
}

// クリーンタスクの拡張
clean {
    delete classDir
    delete jarDir
    delete apiDir
}

tasks.named('test') {
    // Use JUnit Platform for unit tests.
    useJUnitPlatform()
}
